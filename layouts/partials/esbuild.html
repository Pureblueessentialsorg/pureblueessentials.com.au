{{- /* ESBUILD.HTML - Build javascript modules with esbuild
    * Usage:  {{ partial "esbuild" (dict "src" "js/file.js"  "load" "(defer), async " "transpile" "es5","dual" or "" "targetPath" "js/main.js" "targetPathMod" "js/main.mjs" ) }}  
    * Parameters:
    * src - javascript file to build, relative to assets folder
    * targetPath - output path including file name, relative to site root. Can be left unset. 
    * load - default "defer" can be set to "async" or " " . To pre load scripts, call partial in <head> and use defer (default)
    * transpile - default to differential, set to 
    * - es5 to transpile code down to es5 with babel
    * - differential for both es5 (babel) and es6 (module browsers)
    * - es6 to only support module browsers
    * babelEs6 - set to true to transpile es6 using babel (target module browsers)
    * use this option if esbuilt can't handle your code see https://esbuild.github.io/content-types/#javascript
    * for unsupported syntax
    * https://esbuild.github.io/content-types/#javascript
    * for unsupported syntax
    */ -}}

{{- /* add module and iife to file names to show the difference */ -}}
{{- $targetPathMod := .targetPathMod | default .src  -}}
{{- $targetPathMod := strings.TrimRight ".js" $targetPathMod -}}
{{- $targetPathMod = printf "%s.module.min.js" $targetPathMod -}}
{{- $targetPath := .targetPath | default .src  -}}
{{- $targetPath := strings.TrimRight ".js" $targetPath -}}
{{- $targetPath = printf "%s.iife.min.js" $targetPath -}}
{{- $targetPathDev := .targetPath | default .src  -}}
{{- $targetPathDev := strings.TrimRight ".js" $targetPathDev -}}
{{- $targetPathDev = printf "%s.module.js" $targetPathDev -}}
{{- /*  supresses errors if no or error .src is supplied */ -}}
{{- with $src := resources.Get .src -}}
{{- /* for develop environment e.g. hugo server most es6+ features will be lowered to es6 */ -}}
{{- /* https://esbuild.github.io/content-types/#javascript */ -}}
{{- $params := (dict "env" hugo.Environment) -}}
{{- if eq (hugo.Environment) "development" -}}
  {{- $jsConfig := (dict "targetPath" $targetPathDev "sourceMap" "inline" "target" "es2015" "params" $params) -}}
  {{- $src = $src | js.Build $jsConfig | fingerprint "sha512" -}}
  <script {{ $.load | default "defer" | safeHTMLAttr }}
  src="{{- $src.RelPermalink -}}"
  integrity="{{- $src.Data.Integrity -}}">
  </script>
{{ else if ne $.transpile "es5" -}}

{{- /* else if (ne $.onlyEs5 true) */ -}}
{{- /* add option of onlyEs5 = true to set target = es5 */ -}}
  {{- /* create a module file if target is es6 or differential */ -}}
  {{- $jsConfig := (dict "targetPath" $targetPathMod "format" "esm" "target" "es2015" "minify" "true" "params" $params) }}
  {{- $mod := $src | js.Build $jsConfig | fingerprint -}}
  {{- if $.babelEs6 -}}
  {{- $babelConfig := (dict "noComments" true "minified" true "config" "config/babel.module.config.js") -}}
  {{- $mod = $src | js.Build $jsConfig | babel $babelConfig | fingerprint -}}
  {{- end -}}
  <script type="module" 
  {{ if eq $.load "async" -}} async {{- end -}}
  src="{{- $mod.RelPermalink -}}"
  integrity="{{- $mod.Data.Integrity -}}">
  </script>
{{- else if ne $.output "es6" -}}
  {{- /* create a iife js file which is es5 compadible */ -}}
  {{- /* this will not happen if you are only outputting es6 code */ -}}
  {{- /* esbuild does not support lowering es6 to es5 so its outputted as es6 and then babel lowers to es5 as per browserslist */ -}}
  {{- $babelConfig := (dict "noComments" true  "minified" true "config" "config/babel.config.js") -}}
  {{- $jsConfig := (dict "targetPath" $targetPath "target" "es2015" "params" $params) -}}
  {{- $src = $src  | js.Build $jsConfig | babel $babelConfig | fingerprint -}}
  <script {{ $.load | default "defer" | safeHTMLAttr }}
    {{ if ne $.output "es5" }} nomodule {{ end }}
    src="{{- $src.RelPermalink -}}"
    integrity="{{- $src.Data.Integrity -}}">
  </script>
{{ end -}}
{{- end -}}
